<%- include('partials/header', {
  pageTitle: `${anime.title} - AnimeHub`,
  htmlClass: 'dark',
  bodyClass: 'bg-body text-text font-body min-h-screen flex flex-col'
}) %>

  <main class="py-10">
    <div class="container">
      <!-- Breadcrumb -->
      <div class="flex items-center gap-2 text-sm text-subs mb-6">
        <a href="/" class="text-main hover:text-lead transition-colors">Inicio</a>
        <i class="fas fa-chevron-right text-xs"></i>
        <span><%= anime.title %></span>
      </div>
      
      <!-- Anime Hero Section -->
      <section class="relative overflow-hidden border border-line/70 rounded-2xl bg-mute/85 backdrop-blur-xl shadow-2xl mb-12">
        <div class="absolute inset-0">
          <% if (anime.backdrop) { %>
            <img src="<%= anime.backdrop %>" alt="" class="h-full w-full object-cover" onerror="this.style.display='none'">
          <% } %>
          <div class="absolute inset-0 bg-linear-to-r from-body/92 via-body/78 to-transparent"></div>
          <div class="absolute inset-0 bg-linear-to-t from-body/85 via-transparent to-transparent"></div>
        </div>

        <div class="relative container grid gap-8 lg:grid-cols-[320px_1fr] items-start p-6 lg:p-10">
          <div class="w-full">
            <% if (anime.poster) { %>
              <img class="w-full max-w-[320px] lg:w-full h-auto rounded-2xl shadow-2xl border border-line/60" src="<%= anime.poster %>" alt="<%= anime.title %>">
            <% } else { %>
              <div class="w-full max-w-[320px] lg:w-full aspect-poster bg-soft rounded-2xl flex items-center justify-center border border-line/60 shadow-xl">
                <i class="fas fa-image text-4xl text-line"></i>
              </div>
            <% } %>
          </div>

          <div class="flex flex-col gap-6 text-lead h-full">
            <div class="space-y-2">
              <h1 class="text-4xl lg:text-5xl font-bold text-lead"><%= anime.title %></h1>
              <% if (anime.alternativeTitle) { %>
                <h2 class="text-lg text-subs italic"><%= anime.alternativeTitle %></h2>
              <% } %>
            </div>

            <div class="flex flex-wrap gap-2">
              <% if (anime.type) { %>
                <span class="badge-chip badge-chip--muted"><%= anime.type %></span>
              <% } %>
              <% if (anime.year) { %>
                <span class="badge-chip badge-chip--muted">Año · <%= anime.year %></span>
              <% } %>
              <% if (anime.status) { %>
                <span class="badge-chip <%= anime.status === 'En emisión' ? 'badge-chip--status' : 'badge-chip--muted' %>">
                  <%= anime.status %>
                </span>
              <% } %>
              <span class="badge-chip badge-chip--muted"><%= anime.totalEpisodes %> eps</span>
            </div>

            <% if (anime.malRating && anime.malRating !== '0.0') { %>
              <div class="flex flex-wrap items-center gap-4 p-4 rounded-xl border border-line/80 bg-soft/70 shadow-lg w-full">
                <div class="flex items-center gap-2">
                  <i class="fas fa-star text-warn text-xl"></i>
                  <span class="text-xl font-bold text-lead"><%= anime.malRating %></span>
                  <span class="text-xs text-subs uppercase tracking-wide">MAL</span>
                </div>
                <% if (anime.malVotes && anime.malVotes !== '0') { %>
                  <div class="text-sm text-subs">
                    <span><%= anime.malVotes %> votos</span>
                  </div>
                <% } %>
              </div>
            <% } %>

            <% if (anime.genres && anime.genres.length > 0) { %>
              <div class="flex flex-wrap gap-2">
                <% anime.genres.forEach(genre => { %>
                  <span class="genre-tag"><%= genre %></span>
                <% }); %>
              </div>
            <% } %>

            <% if (anime.description) { %>
              <div class="bg-soft/80 border border-line/80 rounded-xl p-4 shadow-md w-full">
                <p class="text-sm leading-relaxed text-text"><%= anime.description %></p>
              </div>
            <% } %>

            <div class="flex flex-wrap gap-3 mt-auto items-end">
              <% if (anime.trailerUrl) { %>
                <a href="<%= anime.trailerUrl %>" target="_blank" class="btn btn-secondary">
                  <i class="fas fa-play"></i>
                  <span>Ver Tráiler</span>
                </a>
              <% } %>
              <button class="btn btn-primary bg-main text-fore border border-main shadow-lg shadow-main/30 hover:bg-tone hover:border-tone hover:text-fore cursor-pointer" id="downloadAllBtn">
                <i class="fas fa-download"></i>
                <span>Descargar Todo</span>
              </button>
              <div class="flex-1"></div>
              <div class="audio-toggle" role="radiogroup" aria-label="Audio">
                <label class="audio-choice">
                  <input type="radio" name="audioType" value="SUB" <%= defaultAudioPreference !== 'DUB' ? 'checked' : '' %>>
                  <span class="audio-option">SUB</span>
                </label>
                <label class="audio-choice">
                  <input type="radio" name="audioType" value="DUB" <%= defaultAudioPreference === 'DUB' ? 'checked' : '' %>>
                  <span class="audio-option">DUB</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Related Animes Timeline -->
      <% if (anime.relatedAnimes && anime.relatedAnimes.length > 0) { %>
        <section class="related-timeline col-span-full">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-link"></i>
              Relacionados
            </h2>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <% anime.relatedAnimes.forEach((related) => { %>
              <%- include('partials/card-anime', { anime: related, variant: 'related' }) %>
            <% }); %>
          </div>
        </section>
      <% } %>

      <!-- Episodes Section -->
      <section class="bg-radial-[closest-side] from-mute col-span-full mt-12 py-3">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4 mb-6">
          <h2 class="text-lead text-2xl font-bold">Episodios</h2>
          
          <div class="flex items-center gap-2">
            <% if (anime.episodeRanges && anime.episodeRanges.length > 1) { %>
              <button class="btn btn-sm btn-soft" id="episodeRangeBtn" style="min-width: 120px;">
                <span class="text-subs" id="currentRange"><%= anime.episodeRanges[0].label %></span>
                <span class="ic-chevron-down text-subs text-lg" aria-hidden="true"></span>
              </button>
            <% } %>
            
            <button type="button" class="btn btn-sm btn-soft tooltip-top p-0" aria-label="Buscar" id="searchBtn">
              <span class="ic-search-md text-lg" aria-hidden="true"></span>
            </button>
            <input type="text" id="episodeSearch" placeholder="Buscar episodio..." class="bg-mute border border-line rounded-lg px-3 py-2 text-sm text-text placeholder-hint focus:border-main focus:outline-none hidden" style="width: 150px;">
            
            <button class="btn btn-sm btn-soft tooltip-top p-0" aria-label="Ordenar" type="button">
              <span class="ic-arrows-up-down text-lg"></span>
            </button>
          </div>
        </div>

        <% if (anime.episodes && anime.episodes.length > 0) { %>
          <div class="grid grid-cols-2 gap-4 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 xl:gap-6" id="episodesContainer">
            <% 
              // Mostrar solo los primeros 50 episodios por defecto
              const episodesToShow = anime.episodes.slice(0, 50);
              episodesToShow.forEach((episode, index) => { 
            %>
              <% 
                const screenshotUrl = anime.animeId ? `https://cdn.animeav1.com/screenshots/${anime.animeId}/${episode.number}.jpg` : null;
                const epData = Object.assign({}, episode, { screenshotUrl });
              %>
              <%- include('partials/card-episode', { episode: epData, variant: 'detail', selectable: true }) %>
            <% }); %>
          </div>
          
          <!-- Bulk Actions -->
          <div class="sticky bottom-8 bg-soft border border-line rounded-lg p-4 mt-6 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-lg z-50" id="bulkActions">
            <div class="text-lead font-medium">
              <span id="selectedCount">0</span> episodios seleccionados
            </div>
            <div class="flex gap-3">
              <button class="inline-flex items-center gap-2 px-4 py-2 bg-main text-fore font-medium rounded-lg hover:opacity-90 transition-opacity" id="downloadSelectedBtn">
                <i class="fas fa-download"></i>
                <span>Descargar Seleccionados</span>
              </button>
              <button class="inline-flex items-center gap-2 px-4 py-2 bg-line text-subs hover:bg-edge hover:text-lead rounded-lg transition-colors" id="clearSelectionBtn">
                <i class="fas fa-times"></i>
                <span>Limpiar Selección</span>
              </button>
            </div>
          </div>
        <% } else { %>
          <div class="text-center py-16 bg-soft border border-line rounded-lg">
            <div class="text-4xl mb-4 text-line">
              <i class="fas fa-film"></i>
            </div>
            <h3 class="text-xl text-lead mb-2">No hay episodios disponibles</h3>
            <p class="text-subs">Los episodios de este anime aún no están disponibles.</p>
          </div>
        <% } %>
      </section>


    </div>
  </main>

  <!-- Toast Notification -->
  <div class="fixed bottom-4 right-4 z-50 hidden" id="toast">
    <div class="bg-soft border border-line rounded-lg p-4 shadow-lg max-w-sm">
      <div class="flex items-center gap-3">
        <div class="shrink-0">
          <i class="fas fa-info-circle text-info" id="toast-icon"></i>
        </div>
        <div class="flex-1">
          <p class="text-sm text-text" id="toast-message">Mensaje</p>
        </div>
        <button class="shrink-0 text-subs hover:text-lead" id="toast-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
  
  <!-- Mobile Navigation -->
  <nav class="bg-body sticky bottom-0 z-30 lg:hidden border-t border-line/20">
    <div class="container flex px-0">
      <a class="flex flex-1 flex-col items-center justify-center h-16 px-0 text-subs hover:text-main" href="/">
        <i class="fas fa-home text-2xl mb-1"></i>
        <span class="text-xs">Inicio</span>
      </a>
      <a class="flex flex-1 flex-col items-center justify-center h-16 px-0 text-subs hover:text-main" href="/catalogo">
        <i class="fas fa-th-large text-2xl mb-1"></i>
        <span class="text-xs">Catálogo</span>
      </a>
      <a class="flex flex-1 flex-col items-center justify-center h-16 px-0 text-subs hover:text-main" href="/horario">
        <i class="fas fa-calendar text-2xl mb-1"></i>
        <span class="text-xs">Horario</span>
      </a>
    </div>
  </nav>

  <script>
    // Pasar datos del anime al JavaScript
    window.animeData = {
      title: '<%= anime.title %>',
      slug: '<%= anime.slug %>',
      animeId: '<%= anime.animeId || '' %>',
      totalEpisodes: <%= anime.totalEpisodes %>,
      defaultAudioPreference: '<%= defaultAudioPreference || "SUB" %>',
      episodes: <%- JSON.stringify(anime.episodes) %>
    };
    
    // Sistema de reintento para imágenes
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('img').forEach(img => {
        let retries = 0;
        const maxRetries = 3;
        
        img.addEventListener('error', function() {
          if (retries < maxRetries) {
            retries++;
            setTimeout(() => {
              this.src = this.src + (this.src.includes('?') ? '&' : '?') + 't=' + Date.now();
            }, 1000 * retries);
          }
        });
      });
    });
  </script>
  <script src="/js/anime.js"></script>
</body>
</html>

